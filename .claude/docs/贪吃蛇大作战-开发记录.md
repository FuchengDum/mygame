# 贪吃蛇大作战 - 开发记录

## 功能概述

基于 Phaser 3 的贪吃蛇游戏，支持 360 度摇杆控制，霓虹渐变视觉风格。

## Bug 修复记录

### 1. 游戏界面未初始化 + setInput 报错

**问题描述**：
- 游戏界面只显示虚拟摇杆，游戏画布未渲染
- 操作摇杆时报错：`Uncaught TypeError: sceneRef.current?.setInput is not a function`

**根因分析**：
- `SnakeGamePage` 传递的场景配置格式与 `PhaserGame` 组件不兼容
- 场景未正确初始化，`getScene('SnakeScene')` 返回的对象没有 `setInput` 方法

**修复方案**：
- 直接在 `SnakeGamePage` 中创建 Phaser 游戏实例
- 通过继承 `SnakeScene` 注入回调函数
- 设置正确的物理引擎配置（重力为 0）

**涉及文件**：`src/pages/SnakeGamePage.tsx`

---

### 2. 路由顺序问题

**问题描述**：访问 `/play/snake` 时可能被 `/play/:id` 路由捕获

**修复方案**：将具体路径 `/play/snake` 移到通配路径 `/play/:id` 之前

**涉及文件**：`src/router/index.tsx`

```tsx
// 修复后
{ path: '/play/snake', element: <SnakeGamePage /> },  // 具体路径优先
{ path: '/play/:id', element: <GamePlayPage /> },     // 通配路径在后
```

---

## 优化记录

### 1. 摇杆操作不顺畅

**问题描述**：蛇的转向响应迟钝，方向变化滞后于手指操作

**优化内容**：

| 优化项 | 修改前 | 修改后 | 效果 |
|--------|--------|--------|------|
| 转向速度 | 0.08 | 0.18 | 转向更灵敏（约 2 倍） |
| 摇杆尺寸 | 120px | 140px | 操作区域更大 |
| 有效范围 | 35px | 50px | 更易控制 |
| 死区 | 无 | 10% | 避免静止抖动 |

**涉及文件**：
- `src/game/games/SnakeGame/SnakeScene.ts` - `turnSpeed` 参数
- `src/components/VirtualController/Joystick.tsx` - 尺寸和死区

---

### 2. 浮动摇杆模式

**问题描述**：固定位置摇杆操作不直观，手指方向与蛇的方向不一致

**优化方案**：改为浮动摇杆模式
- 手指按下的位置即为摇杆中心
- 移动方向直接对应蛇的转向方向
- 摇杆只在触摸时显示

**涉及文件**：`src/components/VirtualController/Joystick.tsx`

---

### 3. 横屏支持

**需求**：支持横屏游戏，横屏时摇杆位置固定

**实现方案**：
- 使用 `useOrientation` hook 检测屏幕方向
- 竖屏：浮动摇杆（手指按下位置为中心）
- 横屏：固定摇杆（左下角 120x120px）

**涉及文件**：
- `src/components/VirtualController/Joystick.tsx` - 添加 `isLandscape` 属性
- `src/pages/SnakeGamePage.tsx` - 传递横屏状态

---

## 文件清单

### 新建文件
- `src/components/VirtualController/Joystick.tsx` - 虚拟摇杆组件
- `src/game/games/SnakeGame/SnakeScene.ts` - 贪吃蛇游戏场景
- `src/pages/SnakeGamePage.tsx` - 游戏页面

### 修改文件
- `src/router/index.tsx` - 添加路由
- `public/data/games.json` - 添加游戏入口

---

## 技术要点

### 摇杆输入处理
```typescript
// 角度计算
const angle = Math.atan2(dy, dx)

// 死区处理
const magnitude = distance / maxDistance
if (magnitude < deadZone) return

// 传递给游戏场景
onInput({ angle, vector: { x: dx / maxDistance, y: dy / maxDistance } })
```

### 蛇的平滑转向
```typescript
// 平滑插值转向
const turnSpeed = 0.18
let angleDiff = this.targetDirection - this.direction
while (angleDiff > Math.PI) angleDiff -= Math.PI * 2
while (angleDiff < -Math.PI) angleDiff += Math.PI * 2
this.direction += angleDiff * turnSpeed
```

### 横竖屏适配
```typescript
// 检测屏幕方向
const isLandscape = useOrientation()

// 根据方向选择摇杆模式
<Joystick onInput={handleInput} isLandscape={isLandscape} />
```
