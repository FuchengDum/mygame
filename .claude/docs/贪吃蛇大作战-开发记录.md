# 贪吃蛇大作战 - 开发记录

## 功能概述

基于 Phaser 3 的贪吃蛇游戏，支持 360 度摇杆控制，霓虹渐变视觉风格。

## Bug 修复记录

### 1. 游戏界面未初始化 + setInput 报错

**问题描述**：
- 游戏界面只显示虚拟摇杆，游戏画布未渲染
- 操作摇杆时报错：`Uncaught TypeError: sceneRef.current?.setInput is not a function`

**根因分析**：
- `SnakeGamePage` 传递的场景配置格式与 `PhaserGame` 组件不兼容
- 场景未正确初始化，`getScene('SnakeScene')` 返回的对象没有 `setInput` 方法

**修复方案**：
- 直接在 `SnakeGamePage` 中创建 Phaser 游戏实例
- 通过继承 `SnakeScene` 注入回调函数
- 设置正确的物理引擎配置（重力为 0）

**涉及文件**：`src/pages/SnakeGamePage.tsx`

---

### 2. 路由顺序问题

**问题描述**：访问 `/play/snake` 时可能被 `/play/:id` 路由捕获

**修复方案**：将具体路径 `/play/snake` 移到通配路径 `/play/:id` 之前

**涉及文件**：`src/router/index.tsx`

```tsx
// 修复后
{ path: '/play/snake', element: <SnakeGamePage /> },  // 具体路径优先
{ path: '/play/:id', element: <GamePlayPage /> },     // 通配路径在后
```

---

## 优化记录

### 1. 摇杆操作不顺畅

**问题描述**：蛇的转向响应迟钝，方向变化滞后于手指操作

**优化内容**：

| 优化项 | 修改前 | 修改后 | 效果 |
|--------|--------|--------|------|
| 转向速度 | 0.08 | 0.18 | 转向更灵敏（约 2 倍） |
| 摇杆尺寸 | 120px | 140px | 操作区域更大 |
| 有效范围 | 35px | 50px | 更易控制 |
| 死区 | 无 | 10% | 避免静止抖动 |

**涉及文件**：
- `src/game/games/SnakeGame/SnakeScene.ts` - `turnSpeed` 参数
- `src/components/VirtualController/Joystick.tsx` - 尺寸和死区

---

### 2. 浮动摇杆模式

**问题描述**：固定位置摇杆操作不直观，手指方向与蛇的方向不一致

**优化方案**：改为浮动摇杆模式
- 手指按下的位置即为摇杆中心
- 移动方向直接对应蛇的转向方向
- 摇杆只在触摸时显示

**涉及文件**：`src/components/VirtualController/Joystick.tsx`

---

### 3. 横屏支持

**需求**：支持横屏游戏，横屏时摇杆位置固定

**实现方案**：
- 使用 `useOrientation` hook 检测屏幕方向
- 竖屏：浮动摇杆（手指按下位置为中心）
- 横屏：固定摇杆（左下角 120x120px）

**涉及文件**：
- `src/components/VirtualController/Joystick.tsx` - 添加 `isLandscape` 属性
- `src/pages/SnakeGamePage.tsx` - 传递横屏状态

---

## 文件清单

### 新建文件
- `src/components/VirtualController/Joystick.tsx` - 虚拟摇杆组件
- `src/game/games/SnakeGame/SnakeScene.ts` - 贪吃蛇游戏场景
- `src/pages/SnakeGamePage.tsx` - 游戏页面

### 修改文件
- `src/router/index.tsx` - 添加路由
- `public/data/games.json` - 添加游戏入口

---

## 技术要点

### 摇杆输入处理
```typescript
// 角度计算
const angle = Math.atan2(dy, dx)

// 死区处理
const magnitude = distance / maxDistance
if (magnitude < deadZone) return

// 传递给游戏场景
onInput({ angle, vector: { x: dx / maxDistance, y: dy / maxDistance } })
```

### 蛇的平滑转向
```typescript
// 平滑插值转向
const turnSpeed = 0.18
let angleDiff = this.targetDirection - this.direction
while (angleDiff > Math.PI) angleDiff -= Math.PI * 2
while (angleDiff < -Math.PI) angleDiff += Math.PI * 2
this.direction += angleDiff * turnSpeed
```

### 横竖屏适配
```typescript
// 检测屏幕方向
const isLandscape = useOrientation()

// 根据方向选择摇杆模式
<Joystick onInput={handleInput} isLandscape={isLandscape} />
```

---

## 功能拓展记录

### 1. 大地图拓展

**需求**：将游戏地图从单屏扩展为大世界地图

**实现方案**：
- 世界尺寸：4000 x 3000 像素
- 相机跟随蛇头移动
- 添加世界边界碰撞检测
- 添加网格背景便于方向感知

**涉及文件**：`src/game/games/SnakeGame/SnakeScene.ts`

```typescript
const WORLD_WIDTH = 4000
const WORLD_HEIGHT = 3000

// 设置世界边界
this.physics.world.setBounds(0, 0, WORLD_WIDTH, WORLD_HEIGHT)
this.cameras.main.setBounds(0, 0, WORLD_WIDTH, WORLD_HEIGHT)

// 相机跟随蛇头
this.cameras.main.startFollow(this.snake[0].graphics, true, 0.1, 0.1)
```

---

### 2. 小地图功能

**需求**：在大地图模式下提供位置感知

**实现方案**：
- 右上角 120x90 像素小地图
- 显示玩家位置（青色点）
- 显示当前视野框（白色矩形）
- 显示特殊食物位置（彩色点）
- 降频绘制（80ms间隔）避免性能问题

**涉及文件**：`src/game/games/SnakeGame/SnakeScene.ts`

---

### 3. 道具系统

**需求**：丰富游戏玩法，增加策略性

**食物类型**：

| 类型 | 颜色 | 分数 | 增长 | 效果 | 持续时间 |
|------|------|------|------|------|----------|
| pellet | 绿色 | 5 | 1 | 无 | - |
| big | 黄色 | 25 | 3 | 无 | - |
| speed | 青色 | 12 | 2 | 加速 1.45x | 5秒 |
| slow | 紫色 | 12 | 2 | 减速 0.75x | 5秒 |
| double | 粉色 | 0 | 0 | 双倍得分 | 8秒 |
| magnet | 蓝色 | 0 | 0 | 吸引食物 | 8秒 |
| poison | 红色 | -20 | 0 | 缩短蛇身 | - |

**Buff 系统**：
- 速度 Buff：影响蛇的移动速度
- 得分 Buff：影响食物得分倍率
- 磁铁 Buff：吸引 260px 范围内的食物

**涉及文件**：
- `src/game/games/SnakeGame/SnakeScene.ts` - 道具定义和效果
- `src/pages/SnakeGamePage.tsx` - Buff 状态 HUD 显示

---

### 4. 地图模式切换

**需求**：快速查看全局地图

**实现方案**：
- 点击地图按钮切换大地图/跟随模式
- 大地图模式：缩放显示整个世界
- 跟随模式：相机跟随蛇头

```typescript
toggleMapMode() {
  if (enabled) {
    cam.stopFollow()
    const zoom = Math.min(cam.width / WORLD_WIDTH, cam.height / WORLD_HEIGHT)
    cam.setZoom(zoom)
    cam.centerOn(WORLD_WIDTH / 2, WORLD_HEIGHT / 2)
  } else {
    cam.setZoom(1)
    cam.startFollow(this.snake[0].graphics, true, 0.1, 0.1)
  }
}
```

---

## 待优化项

### 手机端横屏摇杆性能问题

**问题描述**：PC 端摇杆操作流畅，手机端横屏模式下明显卡顿

**原因分析**：

1. **React 重渲染**：`setOffset()` 在每次 `pointermove` 时触发 React 重渲染
2. **频繁 DOM 查询**：横屏模式每次移动都调用 `getBoundingClientRect()`
3. **CSS 性能**：`box-shadow` 在移动端渲染开销较大

**优化方案**（待实施）：

1. 使用 `useRef` + 直接 DOM 操作替代 `useState`
2. 在 `handleStart` 时缓存容器位置
3. 添加 `will-change: transform` 启用 GPU 加速
4. 可选：使用 `requestAnimationFrame` 节流

```typescript
// 优化示例：直接操作 DOM
const knobRef = useRef<HTMLDivElement>(null)
const offsetRef = useRef({ x: 0, y: 0 })

const handleMove = (clientX: number, clientY: number) => {
  // 计算偏移...
  offsetRef.current = { x: dx, y: dy }
  if (knobRef.current) {
    knobRef.current.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`
  }
}
```
